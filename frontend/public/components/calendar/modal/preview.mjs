// File: components/calendar/modal/preview.mjs
// Source preview functionality for the modal
// Handles HLS playback of source previews generated by the backend

import { sendMessage } from '../../../services/websocket.mjs';

// ================================
// DOM ELEMENT CACHE
// ================================
const dom = {
    video: document.getElementById('modal-preview-video'),
    playBtn: document.getElementById('modal-preview-btn'),
    stopBtn: document.getElementById('modal-stop-preview-btn'),
    sourceUri: document.getElementById('preview-source-uri'),
    inputKind: document.getElementById('preview-input-kind'),
    loadingContainer: document.getElementById('modal-preview-loading'),
    loadingText: document.getElementById('modal-preview-loading-text')
};

// ================================
// MODULE STATE
// ================================
let hls = null; // HLS.js instance
let currentState = 'idle'; // idle, loading, playing, error
let currentSource = null; // { inputKind, uri, inputSettings }

// ================================
// PUBLIC API
// ================================

/**
 * Initialize preview module
 * Called when modal opens
 */
export function initPreview() {
    // Attach event listeners
    dom.playBtn.addEventListener('click', handlePlayClick);
    dom.stopBtn.addEventListener('click', handleStopClick);

    // Listen for WebSocket events
    document.addEventListener('preview:ready', handlePreviewReadyEvent);
    document.addEventListener('preview:error', handlePreviewErrorEvent);
    document.addEventListener('preview:stopped', handlePreviewStoppedEvent);

    // Reset state
    resetPreview();
}

/**
 * Update preview info display
 * @param {Object} source - Source object with inputKind, uri, inputSettings
 */
export function updatePreviewInfo(source) {
    currentSource = source;

    // Update info display
    dom.sourceUri.textContent = source.uri || '-';
    dom.inputKind.textContent = source.inputKind || '-';

    // Set ready state for preview
    setState('idle');
    dom.playBtn.disabled = false;
    dom.playBtn.textContent = '▶ Preview Source';
}

/**
 * Cleanup preview resources
 * Called when modal closes or tab changes
 */
export function cleanupPreview() {
    // Stop preview if playing
    if (currentState === 'playing' || currentState === 'loading') {
        stopPreview();
    }

    // Cleanup HLS instance
    if (hls) {
        hls.destroy();
        hls = null;
    }

    // Remove event listeners
    dom.playBtn.removeEventListener('click', handlePlayClick);
    dom.stopBtn.removeEventListener('click', handleStopClick);
    document.removeEventListener('preview:ready', handlePreviewReadyEvent);
    document.removeEventListener('preview:error', handlePreviewErrorEvent);
}

/**
 * Handle preview ready response from backend
 * @param {string} hlsUrl - HLS playlist URL
 */
export function handlePreviewReady(hlsUrl) {
    if (currentState !== 'loading') return;

    setState('playing');

    // Initialize HLS.js and load stream
    if (Hls.isSupported()) {
        hls = new Hls({
            enableWorker: true,
            lowLatencyMode: false,
            backBufferLength: 10
        });

        hls.loadSource(hlsUrl);
        hls.attachMedia(dom.video);

        hls.on(Hls.Events.MANIFEST_PARSED, () => {
            dom.video.play().catch(err => {
                console.error('Failed to autoplay:', err);
            });
        });

        hls.on(Hls.Events.ERROR, (event, data) => {
            if (data.fatal) {
                console.error('HLS fatal error:', data);

                // Cleanup and notify backend to kill the process
                stopPreview();

                // Show error to user
                handlePreviewError('HLS playback error: ' + data.type);
            }
        });
    } else if (dom.video.canPlayType('application/vnd.apple.mpegurl')) {
        // Native HLS support (Safari)
        dom.video.src = hlsUrl;
        dom.video.addEventListener('loadedmetadata', () => {
            dom.video.play().catch(err => {
                console.error('Failed to autoplay:', err);
            });
        });
    } else {
        handlePreviewError('HLS playback not supported in this browser');
    }
}

/**
 * Handle preview error response from backend
 * @param {string} errorMsg - Error message
 */
export function handlePreviewError(errorMsg) {
    // Don't change state since stopPreview() already sets it to 'idle'
    // Just update button text to show error with warning styling
    dom.playBtn.classList.add('warning-state');
    dom.playBtn.textContent = `⚠ ${errorMsg}`;
    dom.playBtn.disabled = true;

    // Auto-reset after 5 seconds
    setTimeout(() => {
        dom.playBtn.classList.remove('warning-state');
        dom.playBtn.textContent = '▶ Preview Source';
        dom.playBtn.disabled = false;
    }, 5000);
}

/**
 * Handle preview stopped notification from backend (timeout, etc)
 * @param {string} reason - Reason for stopping
 */
export function handlePreviewStopped(reason) {
    console.log('Preview stopped by server:', reason);

    // Cleanup HLS.js gracefully (prevents 404 errors)
    if (hls) {
        hls.destroy();
        hls = null;
    }

    // Reset video element
    if (dom.video) {
        dom.video.src = '';
        dom.video.load();
    }

    // Update UI to show the reason with info styling (blue background)
    setState('idle');
    dom.playBtn.classList.add('info-state');
    dom.playBtn.textContent = `ℹ ${reason}`;
    dom.playBtn.disabled = true;

    // Auto-reset after 5 seconds
    setTimeout(() => {
        dom.playBtn.classList.remove('info-state');
        dom.playBtn.textContent = '▶ Preview Source';
        dom.playBtn.disabled = false;
    }, 5000);
}

// ================================
// PRIVATE HELPERS
// ================================

function handlePlayClick() {
    if (!currentSource || currentState !== 'idle') return;

    // Request preview from backend
    startPreview();
}

function handleStopClick() {
    stopPreview();
}

function startPreview() {
    setState('loading');

    // Set loading message based on source type
    if (currentSource.inputKind === 'browser_source') {
        dom.loadingText.textContent = 'Loading browser engine (5-10 seconds)...';
    } else {
        dom.loadingText.textContent = 'Generating preview...';
    }

    // Send WebSocket request to backend
    sendMessage('startPreview', {
        inputKind: currentSource.inputKind,
        uri: currentSource.uri,
        inputSettings: currentSource.inputSettings || {}
    });
}

function stopPreview() {
    // Stop HLS playback
    if (hls) {
        hls.destroy();
        hls = null;
    }

    // Stop video element
    dom.video.pause();
    dom.video.src = '';

    // Send stop request to backend
    sendMessage('stopPreview', {});

    setState('idle');
}

function setState(newState) {
    currentState = newState;

    switch (newState) {
        case 'idle':
            dom.playBtn.style.display = 'block';
            dom.stopBtn.style.display = 'none';
            dom.video.style.display = 'none';
            dom.loadingContainer.style.display = 'none';
            dom.playBtn.textContent = '▶ Preview Source';
            dom.playBtn.disabled = false;
            break;

        case 'loading':
            dom.playBtn.style.display = 'none';
            dom.stopBtn.style.display = 'none';
            dom.video.style.display = 'none';
            dom.loadingContainer.style.display = 'flex';
            // Loading text is set by startPreview() based on source type
            break;

        case 'playing':
            dom.playBtn.style.display = 'none';
            dom.stopBtn.style.display = 'block';
            dom.video.style.display = 'block';
            dom.loadingContainer.style.display = 'none';
            break;

        case 'error':
            dom.playBtn.style.display = 'block';
            dom.stopBtn.style.display = 'none';
            dom.video.style.display = 'none';
            dom.loadingContainer.style.display = 'none';
            dom.playBtn.disabled = true;
            // Text is set by handlePreviewError
            break;
    }
}

function resetPreview() {
    currentSource = null;
    setState('idle');
    dom.sourceUri.textContent = '-';
    dom.inputKind.textContent = '-';
}

function handlePreviewReadyEvent(event) {
    const { hlsUrl } = event.detail;
    handlePreviewReady(hlsUrl);
}

function handlePreviewErrorEvent(event) {
    const { error } = event.detail;
    handlePreviewError(error);
}

function handlePreviewStoppedEvent(event) {
    const { reason } = event.detail;
    handlePreviewStopped(reason);
}
